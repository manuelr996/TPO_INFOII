/*******************************************************************************************************************************//**
 *
 * @file		DR_RTC.c
 * @brief		Descripcion del modulo
 * @date		8 dic. 2017
 * @author		Rafaele Manuel Adrian
 *
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** INCLUDES
 **********************************************************************************************************************************/
#include "DR_RTC.h"
/***********************************************************************************************************************************
 *** DEFINES PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** MACROS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TIPOS DE DATOS PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TABLAS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PUBLICAS
 **********************************************************************************************************************************/
RTC currentTime;
/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** PROTOTIPO DE FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES GLOBALES AL MODULO
 **********************************************************************************************************************************/

void InitRTC (void)
{
	/* Enable PCLK to the RTC */
	//__set_PCONP(PCRTC, 1);
	PCONP->bits._PCRTC = 1;					//Prendo el periferico RTC

	/* Start RTC with external XTAL */
	RTC_CCR = 0x11;

	//Habilitamos la interrupcion de alarmas


}

uint8_t TimeUpdate(void)
{
	if (GetFailFlag) // If power fail has been detected, return default time.
	{
		currentTime.Seconds = 0; currentTime.Minutes = 0; currentTime.Hours = 0;
		currentTime.DayOfWeek = 0; currentTime.DayofMonth = 1; currentTime.Month = 1; currentTime.Year = 2014;
		return 0;
	}

	currentTime.Seconds = RTC_CTIME->CTIME0.bits.Seconds;
	currentTime.Minutes = RTC_CTIME->CTIME0.bits.Minutes;
	currentTime.Hours = RTC_CTIME->CTIME0.bits.Hours;
	currentTime.DayOfWeek = RTC_CTIME->CTIME0.bits.DayOfWeek;
	currentTime.DayofMonth = RTC_CTIME->CTIME1.bits.DayOfMonth;
	currentTime.Month = RTC_CTIME->CTIME1.bits.Month;
	currentTime.Year = RTC_CTIME->CTIME1.bits.Year;
	return 1;
}

void SetRTCTime (const RTC *rtc)
{
	RTC_CCR = 0x12;		/* Stop RTC */

	/* Update RTC registers */
	RTC_SEC   = rtc->Seconds;
	RTC_MIN   = rtc->Minutes;
	RTC_HOUR  = rtc->Hours;
	RTC_DOW   = rtc->DayOfWeek;
	RTC_DOM   = rtc->DayofMonth;
	RTC_MONTH = rtc->Month;
	RTC_YEAR  = rtc->Year;

	RTC_AUX = _BV(4);	/* Clear power fail flag */
	RTC_CCR = 0x11;		/* Restart RTC, Disable calibration feature */
}
