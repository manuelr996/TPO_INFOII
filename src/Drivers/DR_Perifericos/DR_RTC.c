/*******************************************************************************************************************************//**
 *
 * @file		DR_RTC.c
 * @brief		Descripcion del modulo
 * @date		8 dic. 2017
 * @author		Tomás Bautista Ordóñez
 *
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** INCLUDES
 **********************************************************************************************************************************/
#include "DR_RTC.h"
/***********************************************************************************************************************************
 *** DEFINES PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** MACROS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TIPOS DE DATOS PRIVADOS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** TABLAS PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PUBLICAS
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** VARIABLES GLOBALES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

/***********************************************************************************************************************************
 *** PROTOTIPO DE FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES PRIVADAS AL MODULO
 **********************************************************************************************************************************/

 /***********************************************************************************************************************************
 *** FUNCIONES GLOBALES AL MODULO
 **********************************************************************************************************************************/

void InitRTC (void)
{
	/* Enable PCLK to the RTC */
	//__set_PCONP(PCRTC, 1);
	PCONP->bits._PCRTC = 1;					//Prendo el periferico RTC

	/* Start RTC with external XTAL */
	RTC_CCR = 0x11;
}



uint32_t rtc_gettime (RTC *rtc)	/* 1:RTC valid, 0:RTC volatiled */
{
	uint32_t d, t;


	do {
		t = RTC_CTIME0;
		d = RTC_CTIME1;
	} while (t != RTC_CTIME0 || d != RTC_CTIME1);

	if (RTC_AUX & _BV(4)) {	/* If power fail has been detected, return default time. */
		rtc->sec = 0; rtc->min = 0; rtc->hour = 0;
		rtc->wday = 0; rtc->mday = 1; rtc->month = 1; rtc->year = 2014;
		return 0;
	}

	rtc->sec = t & 63;
	rtc->min = (t >> 8) & 63;
	rtc->hour = (t >> 16) & 31;
	rtc->wday = (t >> 24) & 7;
	rtc->mday = d & 31;
	rtc->month = (d >> 8) & 15;
	rtc->year = (d >> 16) & 4095;
	return 1;
}




void rtc_settime (const RTC *rtc)
{
	RTC_CCR = 0x12;		/* Stop RTC */

	/* Update RTC registers */
	RTC_SEC = rtc->sec;
	RTC_MIN = rtc->min;
	RTC_HOUR = rtc->hour;
	RTC_DOW = rtc->wday;
	RTC_DOM = rtc->mday;
	RTC_MONTH = rtc->month;
	RTC_YEAR = rtc->year;

	RTC_AUX = _BV(4);	/* Clear power fail flag */
	RTC_CCR = 0x11;		/* Restart RTC, Disable calibration feature */
}

/**
 * \fn void reiniciarRTC (void)
 * \brief Pone los valores del RTC en 0
 * \details
 * \param [in] void
 * \return void
 * */
void reiniciarRTC(){
	RTC_CCR &= ~(1);
	RTC_MIN=0;
	RTC_SEC=0;
}
/**
 * \fn void prenderRTC (void)
 * \brief Pone en funcionamiento el RTC
 * \details
 * \param [in] void
 * \return void
 * */
void prenderRTC(){
	RTC_CCR |= (1);
}
/**
 * \fn void apagarRTC (void)
 * \brief apaga el RTC
 * \details
 * \param [in] void
 * \return void
 * */
void apagarRTC(){
	RTC_CCR &= ~(1);
}
